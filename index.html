/**
 * B2B SHIP REQUEST DASHBOARD - HTML UPDATES
 * 
 * This file contains ALL code changes needed for your HTML file.
 * Each section shows exactly what to FIND and what to REPLACE it with.
 * 
 * UPDATES:
 * 1. Auto-lookup button for Order Number field
 * 2. Auto-uppercase for Retailer field
 * 3. Order Date column in Operations Dashboard
 * 4. Hidden Order Date storage in form submission
 * 5. lookupOrderData function
 */

// ============================================================================
// UPDATE 1: ADD AUTO-LOOKUP BUTTON TO ORDER NUMBER FIELD
// ============================================================================

// FIND THIS (around line 673):
/*
                        <div class="form-group">
                            <label class="required">Order Number</label>
                            <input type="text" id="orderNumber" name="orderNumber" required placeholder="Enter order number">
                        </div>
*/

// REPLACE WITH:
                        <div class="form-group">
                            <label class="required">Order Number</label>
                            <div style="display: flex; gap: 10px;">
                                <input type="text" id="orderNumber" name="orderNumber" required placeholder="Enter order number" style="flex: 1;">
                                <button type="button" class="btn btn-secondary" onclick="lookupOrderData()" style="min-width: 120px; padding: 10px 20px;">üîç Look Up</button>
                            </div>
                            <small style="color: #666; display: block; margin-top: 5px;">Auto-fill Client, Retailer, and Ship Method from master data</small>
                        </div>

// ============================================================================
// UPDATE 2: ADD AUTO-UPPERCASE TO RETAILER FIELD
// ============================================================================

// FIND THIS (around line 678):
/*
                        <div class="form-group">
                            <label class="required">Retailer/Customer</label>
                            <input type="text" id="retailer" name="retailer" required placeholder="e.g., Amazon, Nordstrom, Macy's">
                        </div>
*/

// REPLACE WITH:
                        <div class="form-group">
                            <label class="required">Retailer/Customer</label>
                            <input type="text" id="retailer" name="retailer" required placeholder="e.g., Amazon, Nordstrom, Macy's" 
                                   oninput="this.value = this.value.toUpperCase()">
                        </div>

// ============================================================================
// UPDATE 3: ADD lookupOrderData FUNCTION
// ============================================================================

// FIND THIS (around line 1291, after loadClients function):
/*
        // ====================================================================
        // TOGGLE DIMS DATE FIELD
        // ====================================================================
*/

// ADD THIS BEFORE IT:
        // ====================================================================
        // LOOKUP ORDER MASTER DATA (Auto-populate)
        // ====================================================================

        let currentOrderDate = '';  // Store order date from lookup

        async function lookupOrderData() {
            const orderNumber = document.getElementById('orderNumber').value.trim();
            
            if (!orderNumber) {
                alert('Please enter an order number first');
                return;
            }
            
            try {
                const response = await fetch(`${CONFIG.APPS_SCRIPT_URL}?action=lookupOrderMasterData&orderNumber=${encodeURIComponent(orderNumber)}`);
                const result = await response.json();
                
                if (result.found && result.data) {
                    // Auto-populate fields
                    const data = result.data;
                    
                    // Set Client (Company Name)
                    if (data.client) {
                        const clientSelect = document.getElementById('client');
                        // Try to find exact match first
                        let found = false;
                        for (let i = 0; i < clientSelect.options.length; i++) {
                            if (clientSelect.options[i].value === data.client || 
                                clientSelect.options[i].value.includes(data.client)) {
                                clientSelect.value = clientSelect.options[i].value;
                                found = true;
                                break;
                            }
                        }
                        
                        // If not found in dropdown, try partial match
                        if (!found) {
                            for (let i = 0; i < clientSelect.options.length; i++) {
                                if (data.client.includes(clientSelect.options[i].value) || 
                                    clientSelect.options[i].value.includes(data.client)) {
                                    clientSelect.value = clientSelect.options[i].value;
                                    found = true;
                                    break;
                                }
                            }
                        }
                    }
                    
                    // Set Retailer (Ship Company) - will auto-uppercase
                    if (data.retailer) {
                        document.getElementById('retailer').value = data.retailer.toUpperCase();
                    }
                    
                    // Set Requested Mode (Ship Method - no mapping, raw value)
                    if (data.requestedMode) {
                        document.getElementById('mode').value = data.requestedMode;
                    }
                    
                    // Store Order Date (hidden)
                    if (data.orderDate) {
                        currentOrderDate = data.orderDate;
                    }
                    
                    // Show success message
                    alert(`‚úÖ Order data found!\n\nClient: ${data.client || 'N/A'}\nRetailer: ${data.retailer || 'N/A'}\nShip Method: ${data.requestedMode || 'N/A'}\n${data.orderDate ? 'Order Date: ' + data.orderDate : ''}\n\nPlease fill in the remaining fields.`);
                    
                } else {
                    alert(`‚ÑπÔ∏è Order ${orderNumber} not found in Master Data.\n\n${result.message || 'Please fill in fields manually.'}`);
                }
                
            } catch (error) {
                console.error('Lookup error:', error);
                alert('‚ùå Error looking up order data. Please fill in fields manually.');
            }
        }

// ============================================================================
// UPDATE 4: INCLUDE ORDER DATE IN FORM SUBMISSION
// ============================================================================

// FIND THIS (around line 1320):
/*
        document.getElementById('orderRequestForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const orderData = {
                action: 'submitOrder',
                client: document.getElementById('client').value,
                clientPriority: document.getElementById('clientPriority').value,
                orderNumber: document.getElementById('orderNumber').value,
                retailer: document.getElementById('retailer').value,
                po: document.getElementById('po').value,
                requiresDims: document.getElementById('requiresDims').value,
                dimsDueBy: document.getElementById('dimsDueBy').value,
                requestedShipDate: document.getElementById('shipDate').value,
                requestedMode: document.getElementById('mode').value,
                notes: document.getElementById('notes').value,
                createdByName: currentUser.name,
                createdByEmail: currentUser.email
            };
*/

// REPLACE WITH:
        document.getElementById('orderRequestForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const orderData = {
                action: 'submitOrder',
                client: document.getElementById('client').value,
                clientPriority: document.getElementById('clientPriority').value,
                orderNumber: document.getElementById('orderNumber').value,
                retailer: document.getElementById('retailer').value,
                po: document.getElementById('po').value,
                requiresDims: document.getElementById('requiresDims').value,
                dimsDueBy: document.getElementById('dimsDueBy').value,
                requestedShipDate: document.getElementById('shipDate').value,
                requestedMode: document.getElementById('mode').value,
                notes: document.getElementById('notes').value,
                createdByName: currentUser.name,
                createdByEmail: currentUser.email,
                orderDate: currentOrderDate || ''  // NEW: Include Order Date from lookup
            };

// ============================================================================
// UPDATE 5: RESET ORDER DATE WHEN FORM IS RESET
// ============================================================================

// FIND THIS (around line 1374):
/*
        function resetOrderForm() {
            document.getElementById('orderRequestForm').reset();
            document.getElementById('dimsDueByGroup').style.display = 'none';
        }
*/

// REPLACE WITH:
        function resetOrderForm() {
            document.getElementById('orderRequestForm').reset();
            document.getElementById('dimsDueByGroup').style.display = 'none';
            currentOrderDate = '';  // Reset stored order date
        }

// ============================================================================
// UPDATE 6: ADD ORDER DATE COLUMN TO OPERATIONS DASHBOARD TABLE
// ============================================================================

// FIND THIS (around line 1050):
/*
                        <table id="ordersTable">
                            <thead>
                                <tr>
                                    <th>Priority</th>
                                    <th>Client</th>
                                    <th>Order #</th>
                                    <th>Retailer</th>
                                    <th>PO</th>
                                    <th>Dims Due</th>
                                    <th>Ship Date</th>
                                    <th>Mode</th>
                                    <th>Status</th>
                                    <th>WMS Status</th>
                                    <th>SLA Status</th>
                                    <th>Notes</th>
                                    <th>Created At</th>
                                    <th>Days</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
*/

// REPLACE WITH:
                        <table id="ordersTable">
                            <thead>
                                <tr>
                                    <th>Priority</th>
                                    <th>Client</th>
                                    <th>Order #</th>
                                    <th>Retailer</th>
                                    <th>PO</th>
                                    <th>Order Date</th>
                                    <th>Dims Due</th>
                                    <th>Ship Date</th>
                                    <th>Mode</th>
                                    <th>Status</th>
                                    <th>WMS Status</th>
                                    <th>SLA Status</th>
                                    <th>Notes</th>
                                    <th>Created At</th>
                                    <th>Days</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>

// ============================================================================
// UPDATE 7: ADD ORDER DATE TO TABLE ROWS
// ============================================================================

// FIND THIS (around line 1860):
/*
                        row.innerHTML = `
                            <td><span class="${priorityClass}">${order.clientPriority}</span></td>
                            <td>${order.client}</td>
                            <td>${order.orderNumber}</td>
                            <td>${order.retailer}</td>
                            <td>${order.po || 'N/A'}</td>
                            <td>${order.dimsDueBy || 'N/A'}</td>
                            <td>${order.requestedShipDate}</td>
                            <td>${order.requestedMode}</td>
                            <td><span class="${statusClass}">${order.status}</span></td>
                            <td style="font-size: 0.9em;">${order.wmsStatus || 'N/A'}</td>
                            <td><span class="${slaClass}">${order.slaStatus}</span></td>
                            <td style="font-size: 0.85em; max-width: 200px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${order.notes || ''}">${order.notes || ''}</td>
                            <td style="font-size: 0.85em;">${order.createdAt}</td>
                            <td>${order.daysInSystem}</td>
                            <td><button class="btn btn-secondary" style="padding: 6px 12px; font-size: 0.85em;" onclick='editOrder(${orderData})'>‚úèÔ∏è Edit</button></td>
                        `;
*/

// REPLACE WITH:
                        row.innerHTML = `
                            <td><span class="${priorityClass}">${order.clientPriority}</span></td>
                            <td>${order.client}</td>
                            <td>${order.orderNumber}</td>
                            <td>${order.retailer}</td>
                            <td>${order.po || 'N/A'}</td>
                            <td style="font-size: 0.85em;">${order.orderDate || ''}</td>
                            <td>${order.dimsDueBy || 'N/A'}</td>
                            <td>${order.requestedShipDate}</td>
                            <td>${order.requestedMode}</td>
                            <td><span class="${statusClass}">${order.status}</span></td>
                            <td style="font-size: 0.9em;">${order.wmsStatus || 'N/A'}</td>
                            <td><span class="${slaClass}">${order.slaStatus}</span></td>
                            <td style="font-size: 0.85em; max-width: 200px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${order.notes || ''}">${order.notes || ''}</td>
                            <td style="font-size: 0.85em;">${order.createdAt}</td>
                            <td>${order.daysInSystem}</td>
                            <td><button class="btn btn-secondary" style="padding: 6px 12px; font-size: 0.85em;" onclick='editOrder(${orderData})'>‚úèÔ∏è Edit</button></td>
                        `;

// ============================================================================
// UPDATE 8: ADD ORDER DATE TO SORTED TABLE ROWS (in sortOrders function)
// ============================================================================

// FIND THIS (around line 2150, in the sortOrders() function):
/*
                row.innerHTML = `
                    <td><span class="${priorityClass}">${order.clientPriority}</span></td>
                    <td>${order.client}</td>
                    <td>${order.orderNumber}</td>
                    <td>${order.retailer}</td>
                    <td>${order.po || 'N/A'}</td>
                    <td>${order.dimsDueBy || 'N/A'}</td>
                    <td>${order.requestedShipDate}</td>
                    <td>${order.requestedMode}</td>
                    <td><span class="${statusClass}">${order.status}</span></td>
                    <td style="font-size: 0.9em;">${order.wmsStatus || 'N/A'}</td>
                    <td><span class="${slaClass}">${order.slaStatus}</span></td>
                    <td style="font-size: 0.85em; max-width: 200px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${order.notes || ''}">${order.notes || ''}</td>
                    <td style="font-size: 0.85em;">${order.createdAt}</td>
                    <td>${order.daysInSystem}</td>
                    <td><button class="btn btn-secondary" style="padding: 6px 12px; font-size: 0.85em;" onclick='editOrder(${orderData})'>‚úèÔ∏è Edit</button></td>
                `;
*/

// REPLACE WITH THE SAME AS UPDATE 7 (with Order Date column)

// ============================================================================
// UPDATE 9: UPDATE EMPTY TABLE MESSAGE COLSPAN
// ============================================================================

// FIND THIS (around line 1070 and around line 2180):
/*
                    tbody.innerHTML = '<tr><td colspan="15" style="text-align: center; padding: 20px;">No active orders found</td></tr>';
*/

// REPLACE WITH:
                    tbody.innerHTML = '<tr><td colspan="16" style="text-align: center; padding: 20px;">No active orders found</td></tr>';


// ============================================================================
// DEPLOYMENT CHECKLIST
// ============================================================================

/**
 * STEPS TO DEPLOY:
 * 
 * 1. UPDATE BACKEND:
 *    - Replace Google Apps Script with backend-script-updated-v2.gs
 *    - Run function: addOrderDateColumn() (one time migration)
 *    - Run function: initializeSheets() if Order_Master_Data doesn't exist
 *    - Deploy or update deployment
 * 
 * 2. UPDATE FRONTEND:
 *    - Make all 9 updates listed above in your HTML file
 *    - Upload the updated HTML file
 * 
 * 3. PASTE YOUR CONSOLIDATED REPORT:
 *    - Open Google Sheet
 *    - Go to "Order_Master_Data" tab
 *    - Paste your consolidated report (2-3x daily)
 *    - Make sure Column A = Order Number
 * 
 * 4. TEST:
 *    - Create a test order without lookup (should work as before)
 *    - Enter order number and click "üîç Look Up" button
 *    - Verify Client, Retailer, Ship Method auto-fill
 *    - Check Operations Dashboard shows Order Date column
 *    - Run Auto-Archive and verify it uses Order_Master_Data
 * 
 * FEATURES ADDED:
 * ‚úÖ Auto-lookup from consolidated report
 * ‚úÖ Auto-uppercase for Retailer field
 * ‚úÖ Order Date visible in dashboard (hidden in form)
 * ‚úÖ Auto-archive uses Order_Master_Data instead of Aging_Import
 * ‚úÖ Order Date auto-populates from report when dashboard loads
 */
