<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B2B Ship Request Dashboard</title>
    <link rel="icon" href="data:,">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 95%;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Login Screen */
        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .login-modal {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 400px;
            width: 90%;
        }

        .login-modal h2 {
            color: #667eea;
            margin-bottom: 10px;
            text-align: center;
        }

        .login-modal p {
            color: #666;
            margin-bottom: 30px;
            text-align: center;
        }

        .login-form-group {
            margin-bottom: 20px;
        }

        .login-form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }

        .login-form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
        }

        .login-form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .login-button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .login-button:hover {
            transform: translateY(-2px);
        }

        .login-error {
            color: #e74c3c;
            text-align: center;
            margin-top: 15px;
            display: none;
        }

        /* Header */
        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-content h1 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 5px;
        }

        .header-content p {
            color: #666;
            font-size: 1.1em;
        }

        .user-info {
            text-align: right;
        }

        .user-info .name {
            font-weight: 600;
            color: #333;
        }

        .user-info .email {
            color: #666;
            font-size: 0.9em;
        }

        .logout-btn {
            margin-top: 10px;
            padding: 8px 16px;
            background: #f0f0f0;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            color: #666;
            font-size: 0.9em;
        }

        .logout-btn:hover {
            background: #e0e0e0;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: white;
            padding: 10px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            flex-wrap: wrap;
        }

        .tab-button {
            flex: 1;
            min-width: 200px;
            padding: 15px 30px;
            background: #f0f0f0;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #666;
        }

        .tab-button:hover {
            background: #e0e0e0;
            transform: translateY(-2px);
        }

        .tab-button.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        /* Tab Content */
        .tab-content {
            display: none;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .tab-content.active {
            display: block;
        }

        /* Forms */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
            font-size: 0.95em;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .required::after {
            content: " *";
            color: #e74c3c;
        }

        /* Priority Badges */
        .priority-high {
            background: #e74c3c;
            color: white;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            display: inline-block;
        }

        .priority-normal {
            background: #f39c12;
            color: white;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            display: inline-block;
        }

        .priority-low {
            background: #27ae60;
            color: white;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            display: inline-block;
        }

        /* Buttons */
        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        .btn {
            flex: 1;
            min-width: 150px;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #666;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background: #229954;
        }

        /* Messages */
        .success-message,
        .error-message,
        .info-message {
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            display: none;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }

        .info-message {
            background: #e7f3ff;
            border-left: 4px solid #2196F3;
            color: #0c5460;
        }

        /* Loading Spinner */
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Bulk Upload Section */
        .bulk-upload {
            margin-top: 30px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 2px dashed #667eea;
        }

        .bulk-upload h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .file-upload {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .file-upload input[type="file"] {
            flex: 1;
            min-width: 250px;
        }

        /* Dashboard Metrics */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin-top: 25px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .metric-card h3 {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .metric-card .value {
            font-size: 2.5em;
            font-weight: 700;
        }

        /* Orders Table */
        .orders-table {
            margin-top: 30px;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px 14px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
            font-size: 0.95em;
        }

        td {
            padding: 14px 12px;
            border-bottom: 1px solid #e0e0e0;
            font-size: 0.9em;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .status-new {
            color: #3498db;
            font-weight: 600;
        }

        .status-dims-entered {
            color: #27ae60;
            font-weight: 600;
        }

        .status-shipped {
            color: #95a5a6;
            font-weight: 600;
        }

        .sla-on-time {
            background: #d4edda;
            color: #155724;
            padding: 6px 12px;
            border-radius: 6px;
            font-weight: 600;
            display: inline-block;
            font-size: 0.9em;
        }

        .sla-at-risk {
            background: #fff3cd;
            color: #856404;
            padding: 6px 12px;
            border-radius: 6px;
            font-weight: 600;
            display: inline-block;
            font-size: 0.9em;
        }

        .sla-overdue {
            background: #f8d7da;
            color: #721c24;
            padding: 6px 12px;
            border-radius: 6px;
            font-weight: 600;
            display: inline-block;
            font-size: 0.9em;
        }

        /* Dims Entry */
        .search-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .search-box {
            display: flex;
            gap: 15px;
            align-items: end;
        }

        .order-details {
            display: none;
            background: #e7f3ff;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            border-left: 4px solid #2196F3;
        }

        .order-details.show {
            display: block;
        }

        .pallet-entry {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            border: 2px solid #667eea;
        }

        .pallet-list {
            margin-top: 20px;
        }

        .pallet-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                text-align: center;
            }

            .user-info {
                text-align: center;
                margin-top: 15px;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .button-group {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginOverlay" class="login-overlay">
        <div class="login-modal">
            <h2>üöö Welcome</h2>
            <p>B2B Ship Request System</p>
            
            <div class="login-form-group">
                <label>Full Name</label>
                <input type="text" id="loginName" placeholder="Enter your full name" />
            </div>
            
            <div class="login-form-group">
                <label>Email Address</label>
                <input type="email" id="loginEmail" placeholder="your.name@staciamericas.com" />
            </div>
            
            <button class="login-button" onclick="handleLogin()">Login</button>
            
            <p class="login-error" id="loginError"></p>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="mainDashboard" style="display: none;">
        <div class="container">
            <!-- Header -->
            <div class="header">
                <div class="header-content">
                    <h1>üì¶ B2B Ship Request System</h1>
                    <p>Streamlined order management and operations dashboard</p>
                </div>
                <div class="user-info">
                    <div class="name" id="userName"></div>
                    <div class="email" id="userEmail"></div>
                    <button class="logout-btn" onclick="handleLogout()">Logout</button>
                </div>
            </div>

            <!-- Tabs -->
            <div class="tabs">
                <button class="tab-button active" onclick="switchTab('new-request')">üìù New Ship Request</button>
                <button class="tab-button" onclick="switchTab('enter-dims')">üìè Enter Dims</button>
                <button class="tab-button" onclick="switchTab('view-dims')">üì¶ View Dims</button>
                <button class="tab-button" onclick="switchTab('ops-dashboard')">üìä Operations Dashboard</button>
                <button class="tab-button" onclick="switchTab('reports')">üìã Reports & Archive</button>
            </div>

            <!-- Tab 1: New Ship Request -->
            <div id="new-request" class="tab-content active">
                <div class="info-message" style="display: block;">
                    <h4>‚ÑπÔ∏è Order Request Information</h4>
                    <p>Submit B2B order requests for processing. For bulk uploads, use the CSV upload feature below.</p>
                </div>

                <form id="orderRequestForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="required">Client</label>
                            <select id="client" name="client" required>
                                <option value="">Loading clients...</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="required">Client Priority</label>
                            <select id="clientPriority" name="clientPriority" required>
                                <option value="">Select priority...</option>
                                <option value="High">üî¥ High</option>
                                <option value="Normal">üü° Normal</option>
                                <option value="Low">üü¢ Low</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="required">Order Number</label>
                            <input type="text" id="orderNumber" name="orderNumber" required placeholder="Enter order number">
                        </div>

                        <div class="form-group">
                            <label class="required">Retailer/Customer</label>
                            <input type="text" id="retailer" name="retailer" required placeholder="e.g., Amazon, Nordstrom, Macy's">
                        </div>

                        <div class="form-group">
                            <label>PO Number</label>
                            <input type="text" id="po" name="po" placeholder="Enter PO number (optional)">
                        </div>

                        <div class="form-group">
                            <label class="required">Requires Dims?</label>
                            <select id="requiresDims" name="requiresDims" required onchange="toggleDimsDate()">
                                <option value="">Select...</option>
                                <option value="Yes">Yes</option>
                                <option value="No">No</option>
                            </select>
                        </div>

                        <div class="form-group" id="dimsDueByGroup" style="display: none;">
                            <label class="required">Dims Due By</label>
                            <input type="date" id="dimsDueBy" name="dimsDueBy">
                        </div>

                        <div class="form-group">
                            <label class="required">Requested Ship Date</label>
                            <input type="date" id="shipDate" name="shipDate" required>
                        </div>

                        <div class="form-group">
                            <label class="required">Requested Mode</label>
                            <select id="mode" name="mode" required>
                                <option value="">Select...</option>
                                <option value="LTL">LTL</option>
                                <option value="Small Parcel">Small Parcel</option>
                                <option value="FTL">FTL</option>
                                <option value="Rate Shopping">Rate Shopping</option>
                                <option value="TBD">TBD</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="notes" name="notes" placeholder="Additional notes or special instructions"></textarea>
                    </div>

                    <div class="button-group">
                        <button type="submit" class="btn btn-primary">‚úÖ Submit Order Request</button>
                        <button type="button" class="btn btn-secondary" onclick="resetOrderForm()">üîÑ Clear Form</button>
                    </div>
                </form>

                <div class="loading" id="orderLoading">
                    <div class="spinner"></div>
                    <p style="margin-top: 15px;">Submitting order request...</p>
                </div>

                <div class="success-message" id="orderSuccess">
                    <strong>‚úÖ Success!</strong> <span id="orderSuccessText">Your order request has been submitted successfully.</span>
                </div>

                <div class="error-message" id="orderError">
                    <strong>‚ùå Error!</strong> <span id="orderErrorText"></span>
                </div>

                <!-- Bulk Upload Section -->
                <div class="bulk-upload">
                    <h3>üì§ Bulk Upload Orders</h3>
                    <p style="margin-bottom: 15px; color: #666;">
                        Upload a CSV file with multiple orders. <strong>Required columns (in exact order):</strong><br>
                        Client, OrderNumber, Retailer, PO, Requires_Dims, Dims_Due_By, Requested_Ship_Date, Requested_Mode, Notes
                    </p>
                    <div class="file-upload">
                        <input type="file" id="csvFile" accept=".csv" />
                        <button class="btn btn-primary" onclick="processBulkUpload()">üì• Upload & Validate</button>
                    </div>
                    
                    <div class="loading" id="bulkLoading" style="margin-top: 15px;">
                        <div class="spinner"></div>
                        <p style="margin-top: 15px;">Processing CSV file...</p>
                    </div>

                    <div id="bulkValidation" style="display: none; margin-top: 20px;">
                        <h4>Validation Results:</h4>
                        <div id="bulkValidationContent"></div>
                        <div class="button-group" style="margin-top: 20px;">
                            <button class="btn btn-success" onclick="submitValidOrders()">‚úÖ Import Valid Orders</button>
                            <button class="btn btn-secondary" onclick="cancelBulkUpload()">‚ùå Cancel</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab 2: Enter Dims -->
            <div id="enter-dims" class="tab-content">
                <h2 style="margin-bottom: 20px; color: #667eea;">üìè Enter Dimensions</h2>
                
                <div class="search-section">
                    <h3 style="margin-bottom: 15px;">üîç Search Order</h3>
                    <div class="search-box">
                        <div class="form-group" style="flex: 1;">
                            <label>Order Number or PO</label>
                            <input type="text" id="searchTerm" placeholder="Enter order number or PO" />
                        </div>
                        <button class="btn btn-primary" onclick="searchOrder()">Search</button>
                    </div>

                    <div class="loading" id="searchLoading">
                        <div class="spinner"></div>
                        <p style="margin-top: 15px;">Searching...</p>
                    </div>
                </div>

                <div class="order-details" id="orderDetails">
                    <h3>üì¶ Order Details</h3>
                    <div id="orderDetailsContent"></div>
                </div>

                <div class="pallet-entry" id="palletEntry" style="display: none;">
                    <h3>üìê Enter Pallet Dimensions</h3>
                    
                    <div class="pallet-list" id="palletList"></div>

                    <form id="dimsForm">
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="required">Pallet Type</label>
                                <select id="palletType" required>
                                    <option value="">Select pallet type...</option>
                                    <option value="Regular 48x40">Regular 48x40</option>
                                    <option value="Euro 31x47">Euro 31x47</option>
                                    <option value="Plastic">Plastic</option>
                                    <option value="Custom">Custom</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label class="required">Length (inches)</label>
                                <input type="number" id="palletLength" required min="1" step="0.1" placeholder="48">
                            </div>

                            <div class="form-group">
                                <label class="required">Width (inches)</label>
                                <input type="number" id="palletWidth" required min="1" step="0.1" placeholder="40">
                            </div>

                            <div class="form-group">
                                <label class="required">Height (inches)</label>
                                <input type="number" id="palletHeight" required min="1" step="0.1" placeholder="48">
                            </div>

                            <div class="form-group">
                                <label class="required">Weight (lbs)</label>
                                <input type="number" id="palletWeight" required min="1" step="0.1" placeholder="800">
                            </div>

                            <div class="form-group">
                                <label class="required">Carton Count</label>
                                <input type="number" id="cartonCount" required min="1" step="1" placeholder="50">
                            </div>
                        </div>

                        <div class="button-group">
                            <button type="button" class="btn btn-success" onclick="addPallet()">‚ûï Add Pallet</button>
                            <button type="button" class="btn btn-primary" onclick="submitAllDims()">‚úÖ Submit All Dims</button>
                            <button type="button" class="btn btn-secondary" onclick="clearDimsForm()">üîÑ Clear</button>
                        </div>
                    </form>

                    <div class="loading" id="dimsLoading">
                        <div class="spinner"></div>
                        <p style="margin-top: 15px;">Saving dimensions...</p>
                    </div>

                    <div class="success-message" id="dimsSuccess"></div>
                    <div class="error-message" id="dimsError"></div>
                </div>
            </div>

            <!-- Tab 3: View Dims -->
            <div id="view-dims" class="tab-content">
                <h2 style="margin-bottom: 20px; color: #667eea;">üì¶ Orders with Dimensions</h2>
                
                <div class="info-message" style="display: block;">
                    <h4>‚ÑπÔ∏è View All Orders with Entered Dimensions</h4>
                    <p>This shows all orders that have pallet dimensions entered. Click on an order to expand and see detailed pallet information.</p>
                </div>

                <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="loadOrdersWithDims()">üîÑ Refresh</button>
                    <button class="btn btn-success" onclick="openDimsSheet()">üìä Open Dimensions Sheet (Backend)</button>
                </div>
                
                <div class="loading" id="dimsViewLoading">
                    <div class="spinner"></div>
                    <p style="margin-top: 15px;">Loading orders with dimensions...</p>
                </div>

                <div id="dimsViewContent" style="display: none;">
                    <div id="ordersWithDimsList"></div>
                </div>
            </div>

            <!-- Tab 4: Operations Dashboard -->
            <div id="ops-dashboard" class="tab-content">
                <h2 style="margin-bottom: 20px; color: #667eea;">üìä Operations Dashboard</h2>
                
                <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="refreshDashboard()">üîÑ Refresh Dashboard</button>
                    <button class="btn btn-success" onclick="runAutoArchive()">üì¶ Auto-Archive Shipped Orders</button>
                </div>
                
                <div class="info-message" id="archiveInfo" style="display: none;">
                    <h4>‚úÖ Auto-Archive Complete</h4>
                    <p id="archiveMessage"></p>
                </div>
                
                <div class="loading" id="dashboardLoading">
                    <div class="spinner"></div>
                    <p style="margin-top: 15px;">Loading dashboard data...</p>
                </div>

                <div id="dashboardContent" style="display: none;">
                    <div class="dashboard-grid">
                        <div class="metric-card">
                            <h3>Total Active Orders</h3>
                            <div class="value" id="metricTotalActive">0</div>
                        </div>
                        <div class="metric-card">
                            <h3>Pending Dims</h3>
                            <div class="value" id="metricPendingDims">0</div>
                        </div>
                        <div class="metric-card">
                            <h3>üî¥ High Priority</h3>
                            <div class="value" id="metricHighPriority">0</div>
                        </div>
                        <div class="metric-card">
                            <h3>Dims Overdue</h3>
                            <div class="value" id="metricDimsOverdue">0</div>
                        </div>
                        <div class="metric-card">
                            <h3>Shipping Today</h3>
                            <div class="value" id="metricShippingToday">0</div>
                        </div>
                        <div class="metric-card">
                            <h3>Shipping This Week</h3>
                            <div class="value" id="metricShippingWeek">0</div>
                        </div>
                        <div class="metric-card">
                            <h3>Avg Days in System</h3>
                            <div class="value" id="metricAvgDays">0</div>
                        </div>
                    </div>

                    <div class="orders-table">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin: 30px 0 15px 0;">
                            <h3 style="margin: 0; color: #333;">üìã Active Orders</h3>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <label style="font-weight: 500;">Filter by Client:</label>
                                <select id="clientFilter" onchange="filterOrdersByClient()" style="padding: 8px 12px; border: 2px solid #667eea; border-radius: 6px; font-size: 14px;">
                                    <option value="">All Clients</option>
                                </select>
                            </div>
                        </div>
                        <table id="ordersTable">
                            <thead>
                                <tr>
                                    <th>Priority</th>
                                    <th>Client</th>
                                    <th>Order #</th>
                                    <th>Retailer</th>
                                    <th>PO</th>
                                    <th>Dims Due</th>
                                    <th>Ship Date</th>
                                    <th>Mode</th>
                                    <th>Status</th>
                                    <th>WMS Status</th>
                                    <th>SLA Status</th>
                                    <th>Notes</th>
                                    <th>Created At</th>
                                    <th>Days</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="ordersTableBody">
                                <tr>
                                    <td colspan="11" style="text-align: center; padding: 20px;">No orders found</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Edit Order Modal -->
            <div id="editOrderModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 9999; overflow-y: auto;">
                <div style="background: white; max-width: 800px; margin: 50px auto; padding: 30px; border-radius: 15px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                    <h2 style="color: #667eea; margin-bottom: 20px;">‚úèÔ∏è Edit Order</h2>
                    
                    <form id="editOrderForm">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Order Number (Read-only)</label>
                                <input type="text" id="editOrderNumber" readonly style="background: #e9ecef;">
                            </div>

                            <div class="form-group">
                                <label>Client (Read-only)</label>
                                <input type="text" id="editClient" readonly style="background: #e9ecef;">
                            </div>

                            <div class="form-group">
                                <label class="required">Client Priority</label>
                                <select id="editClientPriority" required>
                                    <option value="High">üî¥ High</option>
                                    <option value="Normal">üü° Normal</option>
                                    <option value="Low">üü¢ Low</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label class="required">Retailer</label>
                                <input type="text" id="editRetailer" required>
                            </div>

                            <div class="form-group">
                                <label>PO Number</label>
                                <input type="text" id="editPO">
                            </div>

                            <div class="form-group">
                                <label class="required">Requires Dims?</label>
                                <select id="editRequiresDims" required onchange="toggleEditDimsDue()">
                                    <option value="Yes">Yes</option>
                                    <option value="No">No</option>
                                </select>
                            </div>

                            <div class="form-group" id="editDimsDueGroup">
                                <label>Dims Due By</label>
                                <input type="date" id="editDimsDueBy">
                            </div>

                            <div class="form-group">
                                <label class="required">Requested Ship Date</label>
                                <input type="date" id="editRequestedShipDate" required>
                            </div>

                            <div class="form-group">
                                <label class="required">Requested Mode</label>
                                <select id="editRequestedMode" required>
                                    <option value="">Select mode...</option>
                                    <option value="LTL">LTL</option>
                                    <option value="Small Parcel">Small Parcel</option>
                                    <option value="TBD">TBD</option>
                                    <option value="Rate Shopping">Rate Shopping</option>
                                </select>
                            </div>

                            <div class="form-group" style="grid-column: 1 / -1;">
                                <label>Notes</label>
                                <textarea id="editNotes" rows="3" style="width: 100%;"></textarea>
                            </div>
                        </div>

                        <div class="button-group" style="margin-top: 20px;">
                            <button type="button" class="btn btn-primary" onclick="saveOrderEdit()">üíæ Save Changes</button>
                            <button type="button" class="btn btn-secondary" onclick="closeEditModal()">‚ùå Cancel</button>
                        </div>
                    </form>

                    <div class="success-message" id="editSuccess" style="display: none; margin-top: 15px;"></div>
                    <div class="error-message" id="editError" style="display: none; margin-top: 15px;"></div>
                </div>
            </div>

            <!-- Tab 5: Reports & Archive -->
            <div id="reports" class="tab-content">
                <h2 style="margin-bottom: 20px; color: #667eea;">üìã Reports & Archive</h2>
                
                <div class="info-message" style="display: block;">
                    <h4>üìä Available Reports</h4>
                    <p>Search archived orders and generate reports on SLA compliance, aging, and client performance.</p>
                </div>

                <!-- Archived Orders Search -->
                <div style="background: #f8f9fa; padding: 25px; border-radius: 10px; margin-top: 20px;">
                    <h3 style="color: #667eea; margin-bottom: 15px;">üîç Search Archived Orders</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Start Date</label>
                            <input type="date" id="archiveStartDate" />
                        </div>
                        <div class="form-group">
                            <label>End Date</label>
                            <input type="date" id="archiveEndDate" />
                        </div>
                    </div>
                    <div class="button-group">
                        <button class="btn btn-primary" onclick="searchArchive()">üîç Search Archive</button>
                        <button class="btn btn-success" onclick="exportArchiveCSV()">üì• Export to CSV</button>
                    </div>

                    <div class="loading" id="archiveLoading">
                        <div class="spinner"></div>
                        <p style="margin-top: 15px;">Searching archive...</p>
                    </div>

                    <div id="archiveResults" style="display: none; margin-top: 20px;">
                        <h4>Results:</h4>
                        <div id="archiveResultsContent"></div>
                    </div>
                </div>

                <!-- Quick Stats -->
                <div style="margin-top: 30px; padding: 25px; background: white; border-radius: 10px; border: 2px solid #667eea;">
                    <h3 style="color: #667eea; margin-bottom: 15px;">üìà Quick Stats</h3>
                    <p style="color: #666; margin-bottom: 15px;">Generate reports based on current active orders</p>
                    <div class="button-group">
                        <button class="btn btn-primary" onclick="generateSLAReport()">üìä SLA Compliance Report</button>
                        <button class="btn btn-primary" onclick="generateAgingReport()">‚è±Ô∏è Aging Report</button>
                        <button class="btn btn-primary" onclick="generateClientReport()">üë• Client Performance</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ====================================================================
        // CONFIGURATION
        // ====================================================================
        
        const CONFIG = {
            APPS_SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbx_3858dOL-bVRNvgtnAnxKfRBmOFzMhm4444Yh1LYYCSazEeJ0L9XgtXVtwvqJQoB1/exec',
            SPREADSHEET_ID: '1FgMwIloe9NAUnkl1AU-qFscas1hTzrM4qdnNg14pE64',
            SESSION_KEY: 'shipRequestUser',
            USE_LOCAL_STORAGE: true  // Use localStorage to stay logged in
        };

        let currentUser = null;
        let validOrdersForBulk = [];
        let currentOrderForDims = null;
        let palletsToSubmit = [];

        // ====================================================================
        // INITIALIZATION
        // ====================================================================

        document.addEventListener('DOMContentLoaded', () => {
            checkLogin();
            // Setup auto-fill after DOM is ready
            setTimeout(() => {
                setupPalletAutoFill();
            }, 1000);
        });

        // ====================================================================
        // LOGIN / LOGOUT
        // ====================================================================

        function checkLogin() {
            const storage = CONFIG.USE_LOCAL_STORAGE ? localStorage : sessionStorage;
            const stored = storage.getItem(CONFIG.SESSION_KEY);
            if (stored) {
                currentUser = JSON.parse(stored);
                showDashboard();
            } else {
                document.getElementById('loginOverlay').style.display = 'flex';
            }
        }

        function handleLogin() {
            const name = document.getElementById('loginName').value.trim();
            const email = document.getElementById('loginEmail').value.trim();
            const errorDiv = document.getElementById('loginError');

            if (!name) {
                errorDiv.textContent = 'Please enter your full name';
                errorDiv.style.display = 'block';
                return;
            }

            if (!email || !email.endsWith('@staciamericas.com')) {
                errorDiv.textContent = 'Please enter a valid @staciamericas.com email address';
                errorDiv.style.display = 'block';
                return;
            }

            currentUser = { name, email };
            const storage = CONFIG.USE_LOCAL_STORAGE ? localStorage : sessionStorage;
            storage.setItem(CONFIG.SESSION_KEY, JSON.stringify(currentUser));
            
            document.getElementById('loginOverlay').style.display = 'none';
            showDashboard();
        }

        function handleLogout() {
            if (confirm('Are you sure you want to logout?')) {
                const storage = CONFIG.USE_LOCAL_STORAGE ? localStorage : sessionStorage;
                storage.removeItem(CONFIG.SESSION_KEY);
                currentUser = null;
                location.reload();
            }
        }

        function showDashboard() {
            document.getElementById('mainDashboard').style.display = 'block';
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('userEmail').textContent = currentUser.email;
            
            loadClients();
        }

        // ====================================================================
        // TAB SWITCHING
        // ====================================================================

        function switchTab(tabName) {
            const tabs = document.querySelectorAll('.tab-content');
            const buttons = document.querySelectorAll('.tab-button');
            
            tabs.forEach(tab => tab.classList.remove('active'));
            buttons.forEach(btn => btn.classList.remove('active'));
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            if (tabName === 'ops-dashboard') {
                refreshDashboard();
            } else if (tabName === 'view-dims') {
                loadOrdersWithDims();
            }
        }

        // ====================================================================
        // LOAD CLIENTS
        // ====================================================================

        async function loadClients() {
            try {
                // Load clients from Apps Script API instead of direct Google Sheets
                const response = await fetch(`${CONFIG.APPS_SCRIPT_URL}?action=getClients`);
                const data = await response.json();
                
                const select = document.getElementById('client');
                select.innerHTML = '<option value="">Select a client...</option>';
                
                if (data.clients && data.clients.length > 0) {
                    data.clients.forEach(client => {
                        const option = document.createElement('option');
                        option.value = client;
                        option.textContent = client;
                        select.appendChild(option);
                    });
                } else {
                    select.innerHTML = '<option value="">No clients found</option>';
                }
            } catch (error) {
                console.error('Error loading clients:', error);
                document.getElementById('client').innerHTML = '<option value="">Error loading clients - Check console</option>';
                
                // Fallback: Try to manually populate with known clients
                const fallbackClients = [
                    'Bears with Benefits, Inc.( Havea)',
                    'Biologique Recherche (BR)',
                    'Clariant ( LMC)',
                    'Granado, INC.',
                    'Lampe Berger ( Maison)',
                    'LimeLife USA LLC',
                    'Maelys Cosmetics',
                    'Natura International, Inc.',
                    'Pierre Fabre (PF)',
                    'Promix Nutrition TopCo Inc',
                    'Radixis Inc (DBA Yves Rocher USA)',
                    'Tiffany and Company',
                    'VB Beauty LLC'
                ];
                
                const select = document.getElementById('client');
                select.innerHTML = '<option value="">Select a client...</option>';
                fallbackClients.forEach(client => {
                    const option = document.createElement('option');
                    option.value = client;
                    option.textContent = client;
                    select.appendChild(option);
                });
                
                console.log('Using fallback client list');
            }
        }

        // ====================================================================
        // TOGGLE DIMS DATE FIELD
        // ====================================================================

        function toggleDimsDate() {
            const requiresDims = document.getElementById('requiresDims').value;
            const dimsGroup = document.getElementById('dimsDueByGroup');
            const dimsInput = document.getElementById('dimsDueBy');
            
            if (requiresDims === 'Yes') {
                dimsGroup.style.display = 'block';
                dimsInput.required = true;
            } else {
                dimsGroup.style.display = 'none';
                dimsInput.required = false;
                dimsInput.value = '';
            }
        }


        // ====================================================================
        // ORDER SUBMISSION
        // ====================================================================

        document.getElementById('orderRequestForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const orderData = {
                action: 'submitOrder',
                client: document.getElementById('client').value,
                clientPriority: document.getElementById('clientPriority').value,
                orderNumber: document.getElementById('orderNumber').value,
                retailer: document.getElementById('retailer').value,
                po: document.getElementById('po').value,
                requiresDims: document.getElementById('requiresDims').value,
                dimsDueBy: document.getElementById('dimsDueBy').value,
                requestedShipDate: document.getElementById('shipDate').value,
                requestedMode: document.getElementById('mode').value,
                notes: document.getElementById('notes').value,
                createdByName: currentUser.name,
                createdByEmail: currentUser.email
            };

            document.getElementById('orderLoading').style.display = 'block';
            document.getElementById('orderSuccess').style.display = 'none';
            document.getElementById('orderError').style.display = 'none';

            try {
                const response = await fetch(CONFIG.APPS_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify(orderData)
                });

                const result = await response.json();
                
                document.getElementById('orderLoading').style.display = 'none';
                
                if (result.success) {
                    document.getElementById('orderSuccessText').textContent = 
                        `Order ${result.orderNumber} submitted successfully!`;
                    document.getElementById('orderSuccess').style.display = 'block';
                    
                    setTimeout(() => {
                        resetOrderForm();
                        document.getElementById('orderSuccess').style.display = 'none';
                    }, 3000);
                } else {
                    document.getElementById('orderErrorText').textContent = result.error;
                    document.getElementById('orderError').style.display = 'block';
                }
            } catch (error) {
                console.error('Submission error:', error);
                document.getElementById('orderLoading').style.display = 'none';
                document.getElementById('orderErrorText').textContent = 'Network error. Please try again.';
                document.getElementById('orderError').style.display = 'block';
            }
        });

        function resetOrderForm() {
            document.getElementById('orderRequestForm').reset();
            document.getElementById('dimsDueByGroup').style.display = 'none';
        }

        // ====================================================================
        // BULK UPLOAD
        // ====================================================================

        async function processBulkUpload() {
            const fileInput = document.getElementById('csvFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please select a CSV file first');
                return;
            }

            document.getElementById('bulkLoading').style.display = 'block';
            document.getElementById('bulkValidation').style.display = 'none';

            try {
                const text = await file.text();
                const rows = text.split('\n').map(row => {
                    // Handle quoted fields with commas
                    const matches = row.match(/(".*?"|[^,]+)(?=\s*,|\s*$)/g);
                    return matches ? matches.map(field => field.replace(/^"|"$/g, '').trim()) : [];
                });
                
                // Skip header row and empty rows
                const dataRows = rows.slice(1).filter(row => row.length >= 8 && row[0]);
                
                // Convert to objects
                const orders = dataRows.map(row => ({
                    Client: row[0],
                    OrderNumber: row[1],
                    Retailer: row[2],
                    PO: row[3] || '',
                    Requires_Dims: row[4],
                    Dims_Due_By: row[5] || '',
                    Requested_Ship_Date: row[6],
                    Requested_Mode: row[7],
                    Notes: row[8] || '',
                    ClientPriority: 'Normal',
                    CreatedByName: currentUser.name,
                    CreatedByEmail: currentUser.email
                }));

                // Validate with backend
                const response = await fetch(CONFIG.APPS_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'validateBulkCSV',
                        orders: orders
                    })
                });

                const validation = await response.json();
                
                document.getElementById('bulkLoading').style.display = 'none';
                displayValidation(validation);

            } catch (error) {
                console.error('Bulk upload error:', error);
                document.getElementById('bulkLoading').style.display = 'none';
                alert('Error processing CSV file. Please check the format and try again.');
            }
        }

        function displayValidation(validation) {
            const content = document.getElementById('bulkValidationContent');
            validOrdersForBulk = validation.valid;
            
            let html = `
                <div style="background: #d4edda; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <strong>‚úÖ ${validation.valid.length} valid orders</strong>
                </div>
            `;
            
            if (validation.invalid.length > 0) {
                html += `
                    <div style="background: #f8d7da; padding: 15px; border-radius: 8px;">
                        <strong>‚ùå ${validation.invalid.length} orders with errors:</strong>
                        <ul style="margin-top: 10px; margin-left: 20px;">
                `;
                
                validation.invalid.forEach(item => {
                    html += `<li>Row ${item.row}: ${item.errors.join(', ')}</li>`;
                });
                
                html += `</ul></div>`;
            }
            
            content.innerHTML = html;
            document.getElementById('bulkValidation').style.display = 'block';
        }

        async function submitValidOrders() {
            if (validOrdersForBulk.length === 0) {
                alert('No valid orders to submit');
                return;
            }

            if (!confirm(`Submit ${validOrdersForBulk.length} valid orders?`)) {
                return;
            }

            document.getElementById('bulkLoading').style.display = 'block';
            document.getElementById('bulkValidation').style.display = 'none';

            try {
                const response = await fetch(CONFIG.APPS_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'submitBulkOrders',
                        orders: validOrdersForBulk
                    })
                });

                const result = await response.json();
                
                document.getElementById('bulkLoading').style.display = 'none';
                
                alert(`‚úÖ Successfully imported ${result.success} orders!${result.failed > 0 ? `\n‚ö†Ô∏è ${result.failed} orders failed.` : ''}`);
                
                document.getElementById('csvFile').value = '';
                validOrdersForBulk = [];
                
            } catch (error) {
                console.error('Bulk submission error:', error);
                document.getElementById('bulkLoading').style.display = 'none';
                alert('Error submitting orders. Please try again.');
            }
        }

        function cancelBulkUpload() {
            document.getElementById('bulkValidation').style.display = 'none';
            document.getElementById('csvFile').value = '';
            validOrdersForBulk = [];
        }

        // ====================================================================
        // SEARCH ORDER (FOR DIMS ENTRY)
        // ====================================================================

        async function searchOrder() {
            const searchTerm = document.getElementById('searchTerm').value.trim();
            
            if (!searchTerm) {
                alert('Please enter an order number or PO');
                return;
            }

            document.getElementById('searchLoading').style.display = 'block';
            document.getElementById('orderDetails').classList.remove('show');
            document.getElementById('palletEntry').style.display = 'none';

            try {
                const response = await fetch(`${CONFIG.APPS_SCRIPT_URL}?action=searchOrder&searchTerm=${encodeURIComponent(searchTerm)}`);
                const result = await response.json();
                
                document.getElementById('searchLoading').style.display = 'none';
                
                if (result.found) {
                    currentOrderForDims = result.order;
                    displayOrderDetails(result.order);
                    
                    if (result.order.requiresDims === 'Yes') {
                        document.getElementById('palletEntry').style.display = 'block';
                        loadExistingPallets(result.order.orderNumber);
                    }
                } else {
                    alert('Order not found. Please check the order number or PO and try again.');
                }
            } catch (error) {
                console.error('Search error:', error);
                document.getElementById('searchLoading').style.display = 'none';
                alert('Error searching for order. Please try again.');
            }
        }

        function displayOrderDetails(order) {
            const priorityBadge = order.clientPriority === 'High' ? 'priority-high' :
                                order.clientPriority === 'Low' ? 'priority-low' : 'priority-normal';
            
            const content = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div><strong>Client:</strong> ${order.client}</div>
                    <div><strong>Priority:</strong> <span class="${priorityBadge}">${order.clientPriority}</span></div>
                    <div><strong>Order Number:</strong> ${order.orderNumber}</div>
                    <div><strong>Retailer:</strong> ${order.retailer}</div>
                    <div><strong>PO:</strong> ${order.po || 'N/A'}</div>
                    <div><strong>Ship Date:</strong> ${order.requestedShipDate}</div>
                    <div><strong>Mode:</strong> ${order.requestedMode}</div>
                    <div><strong>Status:</strong> ${order.status}</div>
                    <div><strong>Requires Dims:</strong> ${order.requiresDims}</div>
                    ${order.requiresDims === 'Yes' ? `<div><strong>Dims Due:</strong> ${order.dimsDueBy || 'N/A'}</div>` : ''}
                    <div><strong>Notes:</strong> ${order.notes || 'N/A'}</div>
                </div>
            `;
            
            document.getElementById('orderDetailsContent').innerHTML = content;
            document.getElementById('orderDetails').classList.add('show');
        }

        function loadExistingPallets(orderNumber) {
            // This would fetch existing pallets from the backend
            // For now, we'll reset the pallet list
            palletsToSubmit = [];
            updatePalletList();
        }

        // ====================================================================
        // DIMS ENTRY
        // ====================================================================

        function addPallet() {
            const palletData = {
                type: document.getElementById('palletType').value,
                length: parseFloat(document.getElementById('palletLength').value),
                width: parseFloat(document.getElementById('palletWidth').value),
                height: parseFloat(document.getElementById('palletHeight').value),
                weight: parseFloat(document.getElementById('palletWeight').value),
                cartonCount: parseInt(document.getElementById('cartonCount').value)
            };

            if (!palletData.type || !palletData.length || !palletData.width || !palletData.height || !palletData.weight || !palletData.cartonCount) {
                alert('Please fill in all pallet dimensions and carton count');
                return;
            }

            const cubeFt = (palletData.length * palletData.width * palletData.height / 1728).toFixed(2);
            palletData.cubeFt = cubeFt;

            palletsToSubmit.push(palletData);
            updatePalletList();
            clearDimsInputs();
        }

        function updatePalletList() {
            const listDiv = document.getElementById('palletList');
            
            if (palletsToSubmit.length === 0) {
                listDiv.innerHTML = '<p style="color: #666;">No pallets added yet. Add your first pallet above.</p>';
                return;
            }

            let html = '<h4 style="margin-bottom: 10px;">Pallets to Submit:</h4>';
            palletsToSubmit.forEach((pallet, index) => {
                html += `
                    <div class="pallet-item">
                        <div>
                            <strong>Pallet ${index + 1}:</strong> ${pallet.type} | 
                            ${pallet.length}x${pallet.width}x${pallet.height}" | 
                            ${pallet.weight} lbs | ${pallet.cartonCount} cartons | ${pallet.cubeFt} ft¬≥
                        </div>
                        <button class="btn btn-secondary" style="padding: 8px 16px; min-width: auto;" onclick="removePallet(${index})">Remove</button>
                    </div>
                `;
            });
            
            listDiv.innerHTML = html;
        }

        function removePallet(index) {
            palletsToSubmit.splice(index, 1);
            updatePalletList();
        }

        async function submitAllDims() {
            if (palletsToSubmit.length === 0) {
                alert('Please add at least one pallet');
                return;
            }

            if (!currentOrderForDims) {
                alert('No order selected');
                return;
            }

            document.getElementById('dimsLoading').style.display = 'block';
            document.getElementById('dimsSuccess').style.display = 'none';
            document.getElementById('dimsError').style.display = 'none';

            try {
                // Submit each pallet
                for (const pallet of palletsToSubmit) {
                    const response = await fetch(CONFIG.APPS_SCRIPT_URL, {
                        method: 'POST',
                        body: JSON.stringify({
                            action: 'submitDims',
                            orderNumber: currentOrderForDims.orderNumber,
                            palletType: pallet.type,
                            length: pallet.length,
                            width: pallet.width,
                            height: pallet.height,
                            weight: pallet.weight,
                            cartonCount: pallet.cartonCount,
                            updatedBy: currentUser.name
                        })
                    });

                    const result = await response.json();
                    
                    if (!result.success) {
                        throw new Error(result.message || 'Failed to save dimensions');
                    }
                }

                document.getElementById('dimsLoading').style.display = 'none';
                document.getElementById('dimsSuccess').innerHTML = 
                    `<strong>‚úÖ Success!</strong> Saved ${palletsToSubmit.length} pallet(s) for order ${currentOrderForDims.orderNumber}`;
                document.getElementById('dimsSuccess').style.display = 'block';

                // Clear form
                setTimeout(() => {
                    clearDimsForm();
                    document.getElementById('dimsSuccess').style.display = 'none';
                    document.getElementById('searchTerm').value = '';
                    document.getElementById('orderDetails').classList.remove('show');
                    document.getElementById('palletEntry').style.display = 'none';
                }, 3000);

            } catch (error) {
                console.error('Dims submission error:', error);
                document.getElementById('dimsLoading').style.display = 'none';
                document.getElementById('dimsError').innerHTML = 
                    `<strong>‚ùå Error!</strong> ${error.message}`;
                document.getElementById('dimsError').style.display = 'block';
            }
        }

        function clearDimsInputs() {
            document.getElementById('palletType').value = '';
            document.getElementById('palletLength').value = '';
            document.getElementById('palletWidth').value = '';
            document.getElementById('palletHeight').value = '';
            document.getElementById('palletWeight').value = '';
            document.getElementById('cartonCount').value = '';
        }

        function clearDimsForm() {
            clearDimsInputs();
            palletsToSubmit = [];
            updatePalletList();
        }

        // ====================================================================
        // AUTO-FILL PALLET DIMENSIONS
        // ====================================================================

        function setupPalletAutoFill() {
            const palletTypeSelect = document.getElementById('palletType');
            if (!palletTypeSelect) return;

            palletTypeSelect.addEventListener('change', function() {
                const palletType = this.value;
                const lengthInput = document.getElementById('palletLength');
                const widthInput = document.getElementById('palletWidth');
                
                if (palletType === 'Regular 48x40') {
                    lengthInput.value = 48;
                    widthInput.value = 40;
                    lengthInput.readOnly = true;
                    widthInput.readOnly = true;
                    lengthInput.style.backgroundColor = '#e9ecef';
                    widthInput.style.backgroundColor = '#e9ecef';
                    lengthInput.style.cursor = 'not-allowed';
                    widthInput.style.cursor = 'not-allowed';
                } else if (palletType === 'Euro 31x47') {
                    lengthInput.value = 31;
                    widthInput.value = 47;
                    lengthInput.readOnly = true;
                    widthInput.readOnly = true;
                    lengthInput.style.backgroundColor = '#e9ecef';
                    widthInput.style.backgroundColor = '#e9ecef';
                    lengthInput.style.cursor = 'not-allowed';
                    widthInput.style.cursor = 'not-allowed';
                } else if (palletType === 'Plastic') {
                    lengthInput.value = 48;
                    widthInput.value = 40;
                    lengthInput.readOnly = true;
                    widthInput.readOnly = true;
                    lengthInput.style.backgroundColor = '#e9ecef';
                    widthInput.style.backgroundColor = '#e9ecef';
                    lengthInput.style.cursor = 'not-allowed';
                    widthInput.style.cursor = 'not-allowed';
                } else if (palletType === 'Custom') {
                    lengthInput.value = '';
                    widthInput.value = '';
                    lengthInput.readOnly = false;
                    widthInput.readOnly = false;
                    lengthInput.style.backgroundColor = 'white';
                    widthInput.style.backgroundColor = 'white';
                    lengthInput.style.cursor = 'text';
                    widthInput.style.cursor = 'text';
                } else {
                    lengthInput.value = '';
                    widthInput.value = '';
                    lengthInput.readOnly = false;
                    widthInput.readOnly = false;
                    lengthInput.style.backgroundColor = 'white';
                    widthInput.style.backgroundColor = 'white';
                }
            });
        }

        // ====================================================================
        // OPERATIONS DASHBOARD
        // ====================================================================

        async function refreshDashboard() {
            document.getElementById('dashboardLoading').style.display = 'block';
            document.getElementById('dashboardContent').style.display = 'none';

            try {
                const response = await fetch(`${CONFIG.APPS_SCRIPT_URL}?action=getDashboardData`);
                const data = await response.json();
                
                // Update metrics
                document.getElementById('metricTotalActive').textContent = data.metrics.totalActive;
                document.getElementById('metricPendingDims').textContent = data.metrics.pendingDims;
                document.getElementById('metricHighPriority').textContent = data.metrics.highPriority;
                document.getElementById('metricDimsOverdue').textContent = data.metrics.dimsOverdue;
                document.getElementById('metricShippingToday').textContent = data.metrics.shippingToday;
                document.getElementById('metricShippingWeek').textContent = data.metrics.shippingThisWeek;
                document.getElementById('metricAvgDays').textContent = data.metrics.avgDaysInSystem;

                // Update orders table  
                const tbody = document.getElementById('ordersTableBody');
                tbody.innerHTML = '';
                
                // Store all orders for filtering
                window.allOrders = data.orders || [];
                
                // Populate client filter dropdown
                populateClientFilter(window.allOrders);

                if (data.orders && data.orders.length > 0) {
                    data.orders.forEach(order => {
                        const row = tbody.insertRow();
                        row.setAttribute('data-client', order.client);  // For filtering
                        
                        const priorityClass = order.clientPriority === 'High' ? 'priority-high' :
                                            order.clientPriority === 'Low' ? 'priority-low' : 'priority-normal';
                        
                        const statusClass = order.status === 'New' ? 'status-new' :
                                          order.status === 'Dims Entered' ? 'status-dims-entered' : 'status-shipped';
                        
                        const slaClass = order.slaStatus === 'On Time' ? 'sla-on-time' :
                                       order.slaStatus === 'At Risk' ? 'sla-at-risk' : 'sla-overdue';
                        
                        // Store order data as JSON attribute for editing
                        const orderData = JSON.stringify({
                            orderNumber: order.orderNumber,
                            client: order.client,
                            clientPriority: order.clientPriority,
                            retailer: order.retailer,
                            po: order.po,
                            requiresDims: order.requiresDims,
                            dimsDueBy: order.dimsDueBy,
                            requestedShipDate: order.requestedShipDate,
                            requestedMode: order.requestedMode,
                            notes: order.notes
                        }).replace(/"/g, '&quot;');
                        
                        row.innerHTML = `
                            <td><span class="${priorityClass}">${order.clientPriority}</span></td>
                            <td>${order.client}</td>
                            <td>${order.orderNumber}</td>
                            <td>${order.retailer}</td>
                            <td>${order.po || 'N/A'}</td>
                            <td>${order.dimsDueBy || 'N/A'}</td>
                            <td>${order.requestedShipDate}</td>
                            <td>${order.requestedMode}</td>
                            <td><span class="${statusClass}">${order.status}</span></td>
                            <td style="font-size: 0.9em;">${order.wmsStatus || 'N/A'}</td>
                            <td><span class="${slaClass}">${order.slaStatus}</span></td>
                            <td style="font-size: 0.85em; max-width: 200px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${order.notes || ''}">${order.notes || ''}</td>
                            <td style="font-size: 0.85em;">${order.createdAt}</td>
                            <td>${order.daysInSystem}</td>
                            <td><button class="btn btn-secondary" style="padding: 6px 12px; font-size: 0.85em;" onclick='editOrder(${orderData})'>‚úèÔ∏è Edit</button></td>
                        `;
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="15" style="text-align: center; padding: 20px;">No active orders found</td></tr>';
                }

                document.getElementById('dashboardLoading').style.display = 'none';
                document.getElementById('dashboardContent').style.display = 'block';

            } catch (error) {
                console.error('Dashboard error:', error);
                document.getElementById('dashboardLoading').style.display = 'none';
                alert('Error loading dashboard data. Please make sure your Apps Script URL is configured.');
            }
        }

        function populateClientFilter(orders) {
            const clientFilter = document.getElementById('clientFilter');
            const clients = [...new Set(orders.map(o => o.client))].sort();
            
            // Clear existing options except "All Clients"
            clientFilter.innerHTML = '<option value="">All Clients</option>';
            
            clients.forEach(client => {
                const option = document.createElement('option');
                option.value = client;
                option.textContent = client;
                clientFilter.appendChild(option);
            });
        }

        async function runAutoArchive() {
            if (!confirm('This will archive all orders that are NOT in the WMS aging report (orders that have been shipped). Continue?')) {
                return;
            }

            document.getElementById('archiveInfo').style.display = 'none';
            document.getElementById('dashboardLoading').style.display = 'block';

            try {
                const response = await fetch(`${CONFIG.APPS_SCRIPT_URL}?action=autoArchive`);
                const result = await response.json();

                document.getElementById('dashboardLoading').style.display = 'none';

                if (result.success) {
                    let message = `${result.message} - Archived ${result.archivedCount} order(s).`;
                    
                    if (result.debug) {
                        message += `\n\nDebug Info:\n`;
                        message += `- Orders in Aging_Import: ${result.debug.totalInAgingImport}\n`;
                        message += `- Orders in Ship_Requests: ${result.debug.totalInShipRequests}\n`;
                        message += `- Active in WMS: ${result.debug.activeInWMS}`;
                    }
                    
                    if (result.archivedOrders && result.archivedOrders.length > 0) {
                        message += `\n\nArchived: ${result.archivedOrders.join(', ')}`;
                    }
                    
                    document.getElementById('archiveMessage').innerHTML = message.replace(/\n/g, '<br>');
                    document.getElementById('archiveInfo').style.display = 'block';

                    // Auto-refresh dashboard after 3 seconds
                    setTimeout(() => {
                        refreshDashboard();
                        document.getElementById('archiveInfo').style.display = 'none';
                    }, 3000);
                } else {
                    alert('Error running auto-archive: ' + (result.message || 'Unknown error'));
                }

            } catch (error) {
                console.error('Auto-archive error:', error);
                document.getElementById('dashboardLoading').style.display = 'none';
                alert('Error running auto-archive. Please try again.');
            }
        }

        function filterOrdersByClient() {
            const selectedClient = document.getElementById('clientFilter').value;
            const tbody = document.getElementById('ordersTableBody');
            const rows = tbody.getElementsByTagName('tr');
            
            for (let row of rows) {
                if (selectedClient === '') {
                    row.style.display = '';  // Show all
                } else {
                    const clientCell = row.getAttribute('data-client');
                    row.style.display = clientCell === selectedClient ? '' : 'none';
                }
            }
        }

        // ====================================================================
        // EDIT ORDER FUNCTIONS
        // ====================================================================

        function editOrder(orderData) {
            // Populate form with current order data
            document.getElementById('editOrderNumber').value = orderData.orderNumber;
            document.getElementById('editClient').value = orderData.client;
            document.getElementById('editClientPriority').value = orderData.clientPriority;
            document.getElementById('editRetailer').value = orderData.retailer;
            document.getElementById('editPO').value = orderData.po || '';
            document.getElementById('editRequiresDims').value = orderData.requiresDims;
            document.getElementById('editDimsDueBy').value = orderData.dimsDueBy ? formatDateForInput(orderData.dimsDueBy) : '';
            document.getElementById('editRequestedShipDate').value = orderData.requestedShipDate ? formatDateForInput(orderData.requestedShipDate) : '';
            document.getElementById('editRequestedMode').value = orderData.requestedMode;
            document.getElementById('editNotes').value = orderData.notes || '';

            // Show/hide dims due field
            toggleEditDimsDue();

            // Show modal
            document.getElementById('editOrderModal').style.display = 'block';
            document.getElementById('editSuccess').style.display = 'none';
            document.getElementById('editError').style.display = 'none';
        }

        function formatDateForInput(dateString) {
            // Convert MM-DD-YYYY to YYYY-MM-DD for input[type=date]
            if (!dateString) return '';
            const parts = dateString.split('-');
            if (parts.length === 3) {
                return `${parts[2]}-${parts[0]}-${parts[1]}`;
            }
            return dateString;
        }

        function toggleEditDimsDue() {
            const requiresDims = document.getElementById('editRequiresDims').value;
            const dimsDueGroup = document.getElementById('editDimsDueGroup');
            
            if (requiresDims === 'Yes') {
                dimsDueGroup.style.display = 'block';
            } else {
                dimsDueGroup.style.display = 'none';
                document.getElementById('editDimsDueBy').value = '';
            }
        }

        function closeEditModal() {
            document.getElementById('editOrderModal').style.display = 'none';
        }

        async function saveOrderEdit() {
            document.getElementById('editSuccess').style.display = 'none';
            document.getElementById('editError').style.display = 'none';

            const orderData = {
                action: 'updateOrder',
                orderNumber: document.getElementById('editOrderNumber').value,
                clientPriority: document.getElementById('editClientPriority').value,
                retailer: document.getElementById('editRetailer').value,
                po: document.getElementById('editPO').value,
                requiresDims: document.getElementById('editRequiresDims').value,
                dimsDueBy: document.getElementById('editDimsDueBy').value,
                requestedShipDate: document.getElementById('editRequestedShipDate').value,
                requestedMode: document.getElementById('editRequestedMode').value,
                notes: document.getElementById('editNotes').value
            };

            try {
                const response = await fetch(CONFIG.APPS_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify(orderData)
                });

                const result = await response.json();

                if (result.success) {
                    document.getElementById('editSuccess').innerHTML = '<strong>‚úÖ Success!</strong> Order updated successfully.';
                    document.getElementById('editSuccess').style.display = 'block';

                    // Close modal and refresh dashboard after 1 second
                    setTimeout(() => {
                        closeEditModal();
                        refreshDashboard();
                    }, 1000);
                } else {
                    document.getElementById('editError').innerHTML = '<strong>‚ùå Error:</strong> ' + (result.message || 'Failed to update order');
                    document.getElementById('editError').style.display = 'block';
                }

            } catch (error) {
                console.error('Error updating order:', error);
                document.getElementById('editError').innerHTML = '<strong>‚ùå Error:</strong> Failed to update order. Please try again.';
                document.getElementById('editError').style.display = 'block';
            }
        }


        // ====================================================================
        // REPORTS & ARCHIVE
        // ====================================================================

        async function searchArchive() {
            const startDate = document.getElementById('archiveStartDate').value;
            const endDate = document.getElementById('archiveEndDate').value;

            document.getElementById('archiveLoading').style.display = 'block';
            document.getElementById('archiveResults').style.display = 'none';

            try {
                let url = `${CONFIG.APPS_SCRIPT_URL}?action=getArchivedOrders`;
                if (startDate) url += `&startDate=${startDate}`;
                if (endDate) url += `&endDate=${endDate}`;

                const response = await fetch(url);
                const data = await response.json();
                
                document.getElementById('archiveLoading').style.display = 'none';
                
                if (data.orders && data.orders.length > 0) {
                    let html = `<p><strong>${data.orders.length} archived orders found</strong></p>`;
                    html += '<div style="max-height: 400px; overflow-y: auto; margin-top: 15px;">';
                    html += '<table style="width: 100%;"><thead><tr><th>Order #</th><th>Client</th><th>Retailer</th><th>Ship Date</th><th>Status</th></tr></thead><tbody>';
                    
                    data.orders.forEach(order => {
                        html += `<tr>
                            <td>${order.orderNumber}</td>
                            <td>${order.client}</td>
                            <td>${order.retailer}</td>
                            <td>${order.requestedShipDate}</td>
                            <td>${order.status}</td>
                        </tr>`;
                    });
                    
                    html += '</tbody></table></div>';
                    document.getElementById('archiveResultsContent').innerHTML = html;
                } else {
                    document.getElementById('archiveResultsContent').innerHTML = '<p>No archived orders found for the selected date range.</p>';
                }
                
                document.getElementById('archiveResults').style.display = 'block';

            } catch (error) {
                console.error('Archive search error:', error);
                document.getElementById('archiveLoading').style.display = 'none';
                alert('Error searching archive. Please try again.');
            }
        }

        function exportArchiveCSV() {
            const spreadsheetId = CONFIG.SPREADSHEET_ID;
            const url = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/gviz/tq?tqx=out:csv&sheet=Orders_Archive`;
            window.open(url, '_blank');
        }

        function generateSLAReport() {
            alert('SLA Compliance Report\n\nThis feature will generate a detailed SLA compliance report showing:\n- On-time delivery rate\n- At-risk orders\n- Overdue orders\n- By client breakdown\n\nComing soon!');
        }

        function generateAgingReport() {
            alert('Aging Report\n\nThis feature will generate an aging report showing:\n- Orders by age brackets (0-2, 3-5, 6-10, 10+ days)\n- Average time in system\n- Oldest pending orders\n\nComing soon!');
        }

        function generateClientReport() {
            alert('Client Performance Report\n\nThis feature will generate a client performance report showing:\n- Orders by client\n- Average turnaround time\n- SLA compliance percentage\n- Priority distribution\n\nComing soon!');
        }

        // ====================================================================
        // VIEW DIMS TAB FUNCTIONS
        // ====================================================================

        async function loadOrdersWithDims() {
            document.getElementById('dimsViewLoading').style.display = 'block';
            document.getElementById('dimsViewContent').style.display = 'none';

            try {
                const response = await fetch(`${CONFIG.APPS_SCRIPT_URL}?action=getOrdersWithDims`);
                const data = await response.json();
                
                document.getElementById('dimsViewLoading').style.display = 'none';
                
                if (data.orders && data.orders.length > 0) {
                    displayOrdersWithDims(data.orders);
                    document.getElementById('dimsViewContent').style.display = 'block';
                } else {
                    document.getElementById('ordersWithDimsList').innerHTML = 
                        '<div style="text-align: center; padding: 40px; color: #666;">' +
                        '<h3>No orders with dimensions found</h3>' +
                        '<p>Orders will appear here after dimensions are entered in the "Enter Dims" tab.</p>' +
                        '</div>';
                    document.getElementById('dimsViewContent').style.display = 'block';
                }

            } catch (error) {
                console.error('Error loading orders with dims:', error);
                document.getElementById('dimsViewLoading').style.display = 'none';
                alert('Error loading orders with dimensions. Please check your Apps Script deployment.');
            }
        }

        function displayOrdersWithDims(orders) {
            const container = document.getElementById('ordersWithDimsList');
            let html = '';

            orders.forEach((order, index) => {
                const priorityClass = order.clientPriority === 'High' ? 'priority-high' :
                                    order.clientPriority === 'Low' ? 'priority-low' : 'priority-normal';
                
                html += `
                    <div style="background: white; border: 2px solid #667eea; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 15px;">
                            <div>
                                <h3 style="color: #667eea; margin-bottom: 5px;">
                                    Order #${order.orderNumber} 
                                    <span class="${priorityClass}" style="margin-left: 10px;">${order.clientPriority}</span>
                                </h3>
                                <div style="color: #666;">
                                    <strong>${order.client}</strong> | ${order.retailer} | ${order.requestedMode}
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 1.2em; font-weight: bold; color: #667eea;">
                                    ${order.totalPallets} Pallet${order.totalPallets > 1 ? 's' : ''}
                                </div>
                                <div style="color: #666;">
                                    ${order.totalCubeFt} ft¬≥ | ${order.totalWeight} lbs
                                </div>
                            </div>
                        </div>

                        <button class="btn btn-secondary" onclick="togglePalletDetails(${index})" 
                                style="width: 100%; margin-bottom: 10px;" id="toggleBtn${index}">
                            üì¶ View Pallet Details ‚ñº
                        </button>

                        <div id="palletDetails${index}" style="display: none; background: #f8f9fa; padding: 15px; border-radius: 8px;">
                            ${order.pallets.map((pallet, pIndex) => `
                                <div style="background: white; padding: 12px; border-radius: 6px; margin-bottom: 10px; border-left: 4px solid #667eea;">
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; font-size: 0.95em;">
                                        <div><strong>Pallet ${pallet.palletNumber}:</strong> ${pallet.palletType}</div>
                                        <div><strong>Dimensions:</strong> ${pallet.length}x${pallet.width}x${pallet.height}"</div>
                                        <div><strong>Weight:</strong> ${pallet.weight} lbs</div>
                                        <div><strong>Cartons:</strong> ${pallet.cartonCount || 0}</div>
                                        <div><strong>Cube:</strong> ${pallet.cubeFt} ft¬≥</div>
                                        <div><strong>Footprint:</strong> ${pallet.footprint}</div>
                                        <div><strong>Entered by:</strong> ${pallet.updatedBy}</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>

                        <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #e0e0e0; color: #666; font-size: 0.9em;">
                            <strong>PO:</strong> ${order.po || 'N/A'} | 
                            <strong>Ship Date:</strong> ${order.requestedShipDate} | 
                            <strong>Status:</strong> ${order.status}
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function togglePalletDetails(index) {
            const detailsDiv = document.getElementById(`palletDetails${index}`);
            const btn = document.getElementById(`toggleBtn${index}`);
            
            if (detailsDiv.style.display === 'none') {
                detailsDiv.style.display = 'block';
                btn.innerHTML = 'üì¶ Hide Pallet Details ‚ñ≤';
            } else {
                detailsDiv.style.display = 'none';
                btn.innerHTML = 'üì¶ View Pallet Details ‚ñº';
            }
        }

        function openDimsSheet() {
            const url = `https://docs.google.com/spreadsheets/d/${CONFIG.SPREADSHEET_ID}/edit`;
            window.open(url, '_blank');
            alert('Opening Google Sheets in new tab. Look for the "Order_Dims" tab at the bottom.');
        }

    </script>
</body>
</html>
